<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drillions Allum â€” Social</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --neon:#00ff99;
      --neon-weak:rgba(0,255,153,0.18);
      --bg:#000;
      --panel: rgba(0,0,0,0.7);
      --glass: rgba(255,255,255,0.02);
      --max-width:1100px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--neon);font-family:Orbitron,monospace}
    /* layout */
    .wrap{max-width:var(--max-width);margin:0 auto;display:grid;grid-template-columns:260px 1fr;gap:12px;height:100vh;padding:18px;box-sizing:border-box}
    .sidebar{background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(0,255,153,0.08);display:flex;flex-direction:column;justify-content:space-between;min-height:0}
    .main{display:flex;flex-direction:column;gap:12px;min-height:0}
    header{font-weight:700;padding:6px 0;border-bottom:2px solid var(--neon);text-align:center}
    .user{font-size:0.95rem;opacity:0.95;margin-bottom:8px}
    .feed{background:linear-gradient(180deg, transparent, rgba(0,0,0,0.25));padding:12px;border-radius:8px;overflow:auto;flex:1;border:1px solid rgba(0,255,153,0.04)}
    .msg{padding:10px;border-bottom:1px solid var(--neon-weak);display:block}
    .msg .who{color:var(--neon);font-weight:700}
    .meta{font-size:0.75rem;color:rgba(255,255,255,0.45);margin-left:8px}
    .controls{margin-top:6px}
    .controls button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--neon);padding:6px;margin-right:6px;border-radius:6px;font-size:0.78rem;cursor:pointer}
    .controls button:hover{box-shadow:0 0 8px rgba(0,255,153,0.12);transform:translateY(-1px)}
    .composer{display:flex;gap:8px;align-items:center;border-top:2px solid rgba(0,255,153,0.08);padding-top:10px}
    .composer input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(0,255,153,0.08);background:transparent;color:var(--neon);outline:none}
    .composer button{background:var(--neon);color:#000;border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .composer button:active{transform:translateY(1px)}
    /* matrix canvas behind everything */
    canvas{position:fixed;left:0;top:0;z-index:-1;width:100vw;height:100vh;display:block}
    /* transitions */
    .fade-in{opacity:0;transform:translateY(6px);transition:opacity .5s ease, transform .35s ease}
    .fade-in.visible{opacity:1;transform:none}
    /* small screens: single column, composer sticky bottom */
    @media (max-width:860px){
      .wrap{grid-template-columns:1fr;padding:12px;height:100vh}
      .sidebar{order:2;display:flex;flex-direction:row;align-items:center;gap:10px}
      .main{order:1}
      .composer{position:sticky;bottom:0;background:linear-gradient(#000, rgba(0,0,0,0.2));padding:10px;border-radius:0;margin:-6px -6px 0}
    }
  </style>
</head>
<body>
  <canvas id="matrix"></canvas>

  <div class="wrap fade-in" id="app">
    <aside class="sidebar">
      <div>
        <header>ðŸ’¬ Drillions Lounge â€” Allum</header>
        <div class="user" id="userInfo">loading...</div>
        <div style="font-size:.9rem;color:rgba(255,255,255,0.6)">Live feed â€¢ persistent comments â€¢ replies & DMs next</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button id="openSecret" style="background:transparent;color:var(--neon);border:1px solid rgba(0,255,153,0.06);padding:8px;border-radius:8px;cursor:pointer">Secret Board</button>
        <button id="logout" style="background:var(--neon);color:#000;border:none;padding:10px;border-radius:8px;cursor:pointer">Logout</button>
      </div>
    </aside>

    <main class="main">
      <section id="feed" class="feed" aria-live="polite"></section>

      <div class="composer" role="region" aria-label="Send message">
        <input id="messageInput" placeholder="Transmit your thought..." autocomplete="off" />
        <button id="sendBtn">SEND</button>
      </div>
    </main>
  </div>

  <script type="module">
  // MATRIX: requestAnimationFrame + resize throttle for better mobile perf
  const canvas = document.getElementById('matrix'), ctx = canvas.getContext('2d');
  let width=innerWidth, height=innerHeight;
  const setSize=()=>{ width=canvas.width=innerWidth; height=canvas.height=innerHeight; cols=Math.floor(width/16); if(!drops || drops.length!==cols) drops=new Array(cols).fill(1) };
  window.addEventListener('resize', debounce(setSize,120));
  let drops = []; setSize();
  const letters = "DRILLIONS0101010";
  const fontSize = 16;
  ctx.font = fontSize + "px monospace";
  function frame(){
    ctx.fillStyle = "rgba(0,0,0,0.06)";
    ctx.fillRect(0,0,width,height);
    ctx.fillStyle = "#00ff99";
    for(let i=0;i<drops.length;i++){
      const text = letters.charAt(Math.floor(Math.random()*letters.length));
      ctx.fillText(text, i*fontSize, drops[i]*fontSize);
      if(drops[i]*fontSize > height && Math.random()>0.975) drops[i]=0;
      drops[i]++;
    }
    raf = requestAnimationFrame(frame);
  }
  let raf = requestAnimationFrame(frame);
  function debounce(fn,t){let id; return function(){clearTimeout(id); id=setTimeout(fn,t)}}

  // FIREBASE + UI logic
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const cfg = {
    apiKey: "AIzaSyBujCcMRMq0UEUkU7oJsyOzg0AwAO0NNdY",
    authDomain: "drillionscomments.firebaseapp.com",
    projectId: "drillionscomments",
    storageBucket: "drillionscomments.firebasestorage.app",
    messagingSenderId: "1007277277571",
    appId: "1:1007277277571:web:343c8dd68b844ec91e76b6",
    measurementId: "G-BJJ9LJ1MB7"
  };
  const app = initializeApp(cfg);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI refs
  const feed = document.getElementById('feed');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const logoutBtn = document.getElementById('logout');
  const userInfo = document.getElementById('userInfo');
  const appWrap = document.getElementById('app');

  // helper: escape text for HTML
  function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]) }

  // show app after small delay for smoothness
  function showApp(){ appWrap.classList.add('visible') }

  // auth guard + realtime
  onAuthStateChanged(auth, user=>{
    if(!user){ location.href='index.html'; return }
    const username = user.displayName || user.email.split('@')[0];
    userInfo.innerHTML = `Signed in as <strong>@${esc(username)}</strong>`;
    showApp();

    // live listener: latest 200 messages, newest last
    const q = query(collection(db,'posts'), orderBy('timestamp','asc'));
    const unsub = onSnapshot(q, snap=>{
      // efficient rebuild: create fragment
      const frag = document.createDocumentFragment();
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const id = docSnap.id;
        const row = document.createElement('div');
        row.className='msg';
        const isOwner = d.uid === user.uid;
        const isAdmin = user.email === 'dejuanj35@gmail.com';
        row.innerHTML = `
          <div><span class="who">@${esc(d.user)}</span>
          <span class="meta">${d.timestamp?.toDate ? new Date(d.timestamp.toDate()).toLocaleString() : ''}</span></div>
          <div style="margin-top:6px">${esc(d.text)}</div>
        `;
        if(isOwner || isAdmin){
          const controls = document.createElement('div');
          controls.className='controls';
          const edit = document.createElement('button'); edit.textContent='Edit';
          const del = document.createElement('button'); del.textContent='Delete';
          edit.onclick = async ()=> {
            const val = prompt('Edit your message', d.text);
            if(val && val.trim()!=='' ) await updateDoc(doc(db,'posts',id), { text: val });
          };
          del.onclick = async ()=> {
            if(confirm('Delete message?')) await deleteDoc(doc(db,'posts',id));
          };
          controls.appendChild(edit); controls.appendChild(del);
          row.appendChild(controls);
        }
        frag.appendChild(row);
      });
      // replace feed children
      feed.innerHTML = '';
      feed.appendChild(frag);
      feed.scrollTop = feed.scrollHeight;
    });

    // send
    sendBtn.onclick = async ()=>{
      const val = input.value.trim();
      if(!val) return;
      await addDoc(collection(db,'posts'), {
        uid: user.uid,
        user: username,
        text: val,
        timestamp: serverTimestamp()
      });
      input.value='';
    };

    logoutBtn.onclick = async ()=>{ await signOut(auth); location.href='index.html' };
  });

  // keyboard send (Enter) â€” mobile friendly: shift+enter for newline
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
  });

  // graceful fade-in
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(()=>appWrap.classList.add('visible'),120));
  </script>
</body>
</html>
